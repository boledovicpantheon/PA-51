Bringing machine 'node-1' up with 'virtualbox' provider...
Bringing machine 'node-2' up with 'virtualbox' provider...
Bringing machine 'master-1' up with 'virtualbox' provider...
==> node-1: Importing base box 'box/packer_ubuntu-server-22.04.box'...

[KProgress: 10%
[KProgress: 20%
[KProgress: 30%
[KProgress: 40%
[KProgress: 60%
[KProgress: 70%
[KProgress: 80%
[KProgress: 90%
[K==> node-1: Matching MAC address for NAT networking...
==> node-1: Setting the name of the VM: node-1
==> node-1: Clearing any previously set network interfaces...
==> node-1: Preparing network interfaces based on configuration...
    node-1: Adapter 1: nat
    node-1: Adapter 2: hostonly
==> node-1: Forwarding ports...
    node-1: 22 (guest) => 20301 (host) (adapter 1)
    node-1: 22 (guest) => 2222 (host) (adapter 1)
==> node-1: Running 'pre-boot' VM customizations...
==> node-1: Booting VM...
==> node-1: Waiting for machine to boot. This may take a few minutes...
    node-1: SSH address: 127.0.0.1:2222
    node-1: SSH username: vagrant
    node-1: SSH auth method: private key
    node-1: Warning: Connection reset. Retrying...
    node-1: Warning: Remote connection disconnect. Retrying...
    node-1: 
    node-1: Vagrant insecure key detected. Vagrant will automatically replace
    node-1: this with a newly generated keypair for better security.
    node-1: 
    node-1: Inserting generated public key within guest...
    node-1: Removing insecure key from the guest if it's present...
    node-1: Key inserted! Disconnecting and reconnecting using new SSH key...
==> node-1: Machine booted and ready!
==> node-1: Checking for guest additions in VM...
    node-1: The guest additions on this VM do not match the installed version of
    node-1: VirtualBox! In most cases this is fine, but in rare cases it can
    node-1: prevent things such as shared folders from working properly. If you see
    node-1: shared folder errors, please make sure the guest additions within the
    node-1: virtual machine match the version of VirtualBox you have installed on
    node-1: your host and reload your VM.
    node-1: 
    node-1: Guest Additions Version: 6.0.0 r127566
    node-1: VirtualBox Version: 6.1
==> node-1: Setting hostname...
==> node-1: Configuring and enabling network interfaces...
==> node-1: Mounting shared folders...
    node-1: /vagrant => /home/maros.boledovic@pantheon.local/pa-academy/pa-51
==> node-2: Importing base box 'box/packer_ubuntu-server-22.04.box'...

[KProgress: 10%
[KProgress: 20%
[KProgress: 30%
[KProgress: 40%
[KProgress: 60%
[KProgress: 70%
[KProgress: 80%
[KProgress: 90%
[K==> node-2: Matching MAC address for NAT networking...
==> node-2: Setting the name of the VM: node-2
==> node-2: Fixed port collision for 22 => 2222. Now on port 2200.
==> node-2: Clearing any previously set network interfaces...
==> node-2: Preparing network interfaces based on configuration...
    node-2: Adapter 1: nat
    node-2: Adapter 2: hostonly
==> node-2: Forwarding ports...
    node-2: 22 (guest) => 20302 (host) (adapter 1)
    node-2: 22 (guest) => 2200 (host) (adapter 1)
==> node-2: Running 'pre-boot' VM customizations...
==> node-2: Booting VM...
==> node-2: Waiting for machine to boot. This may take a few minutes...
    node-2: SSH address: 127.0.0.1:2200
    node-2: SSH username: vagrant
    node-2: SSH auth method: private key
    node-2: 
    node-2: Vagrant insecure key detected. Vagrant will automatically replace
    node-2: this with a newly generated keypair for better security.
    node-2: 
    node-2: Inserting generated public key within guest...
    node-2: Removing insecure key from the guest if it's present...
    node-2: Key inserted! Disconnecting and reconnecting using new SSH key...
==> node-2: Machine booted and ready!
==> node-2: Checking for guest additions in VM...
    node-2: The guest additions on this VM do not match the installed version of
    node-2: VirtualBox! In most cases this is fine, but in rare cases it can
    node-2: prevent things such as shared folders from working properly. If you see
    node-2: shared folder errors, please make sure the guest additions within the
    node-2: virtual machine match the version of VirtualBox you have installed on
    node-2: your host and reload your VM.
    node-2: 
    node-2: Guest Additions Version: 6.0.0 r127566
    node-2: VirtualBox Version: 6.1
==> node-2: Setting hostname...
==> node-2: Configuring and enabling network interfaces...
==> node-2: Mounting shared folders...
    node-2: /vagrant => /home/maros.boledovic@pantheon.local/pa-academy/pa-51
==> master-1: Importing base box 'box/packer_ubuntu-server-22.04.box'...

[KProgress: 10%
[KProgress: 20%
[KProgress: 30%
[KProgress: 40%
[KProgress: 60%
[KProgress: 70%
[KProgress: 80%
[KProgress: 90%
[K==> master-1: Matching MAC address for NAT networking...
==> master-1: Setting the name of the VM: master-1
==> master-1: Fixed port collision for 22 => 2222. Now on port 2201.
==> master-1: Clearing any previously set network interfaces...
==> master-1: Preparing network interfaces based on configuration...
    master-1: Adapter 1: nat
    master-1: Adapter 2: hostonly
==> master-1: Forwarding ports...
    master-1: 22 (guest) => 20201 (host) (adapter 1)
    master-1: 22 (guest) => 2201 (host) (adapter 1)
==> master-1: Running 'pre-boot' VM customizations...
==> master-1: Booting VM...
==> master-1: Waiting for machine to boot. This may take a few minutes...
    master-1: SSH address: 127.0.0.1:2201
    master-1: SSH username: vagrant
    master-1: SSH auth method: private key
    master-1: 
    master-1: Vagrant insecure key detected. Vagrant will automatically replace
    master-1: this with a newly generated keypair for better security.
    master-1: 
    master-1: Inserting generated public key within guest...
    master-1: Removing insecure key from the guest if it's present...
    master-1: Key inserted! Disconnecting and reconnecting using new SSH key...
==> master-1: Machine booted and ready!
==> master-1: Checking for guest additions in VM...
    master-1: The guest additions on this VM do not match the installed version of
    master-1: VirtualBox! In most cases this is fine, but in rare cases it can
    master-1: prevent things such as shared folders from working properly. If you see
    master-1: shared folder errors, please make sure the guest additions within the
    master-1: virtual machine match the version of VirtualBox you have installed on
    master-1: your host and reload your VM.
    master-1: 
    master-1: Guest Additions Version: 6.0.0 r127566
    master-1: VirtualBox Version: 6.1
==> master-1: Setting hostname...
==> master-1: Configuring and enabling network interfaces...
==> master-1: Mounting shared folders...
    master-1: /vagrant => /home/maros.boledovic@pantheon.local/pa-academy/pa-51
==> master-1: Running provisioner: ansible_local...
    master-1: Installing Ansible...
    master-1: Running ansible-playbook...

PLAY [Initial configuration and installation] **********************************

TASK [setup : Stop apt-daily] **************************************************
changed: [master-1] => (item=apt-daily.timer)
changed: [node-1] => (item=apt-daily.timer)
changed: [node-2] => (item=apt-daily.timer)
changed: [master-1] => (item=apt-daily-upgrade.timer)
changed: [node-2] => (item=apt-daily-upgrade.timer)
changed: [node-1] => (item=apt-daily-upgrade.timer)

TASK [setup : Make enviroment non-interactive 1/2] *****************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [setup : Make enviroment non-interactive 2/2] *****************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [setup : Running apt-get upgrade] *****************************************
ok: [node-1]
ok: [node-2]
changed: [master-1]

TASK [setup : Running apt-get dist-upgrade] ************************************
ok: [master-1]
ok: [node-1]
ok: [node-2]

TASK [setup : Pasting IP adresses of hosts and master] *************************
changed: [master-1] => (item={'ip': '192.168.56.11', 'name': 'master-1'})
changed: [node-1] => (item={'ip': '192.168.56.11', 'name': 'master-1'})
changed: [node-2] => (item={'ip': '192.168.56.11', 'name': 'master-1'})
changed: [master-1] => (item={'ip': '192.168.56.101', 'name': 'node-1'})
changed: [node-1] => (item={'ip': '192.168.56.101', 'name': 'node-1'})
changed: [node-2] => (item={'ip': '192.168.56.101', 'name': 'node-1'})
changed: [master-1] => (item={'ip': '192.168.56.102', 'name': 'node-2'})
changed: [node-1] => (item={'ip': '192.168.56.102', 'name': 'node-2'})
changed: [node-2] => (item={'ip': '192.168.56.102', 'name': 'node-2'})

TASK [setup : Setting DNS server address to 8.8.8.8] ***************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [setup : Restart systemd-resolved] ****************************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [setup : Disable UFW] *****************************************************
ok: [master-1]
ok: [node-1]
ok: [node-2]

TASK [setup : Allow 'vagrant' to have passwordless sudo] ***********************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [setup : Install basic apt-get packages] **********************************
ok: [master-1] => (item=python3-apt)
ok: [node-1] => (item=python3-apt)
changed: [master-1] => (item=apt-transport-https)
ok: [node-2] => (item=python3-apt)
ok: [master-1] => (item=ca-certificates)
ok: [master-1] => (item=curl)
changed: [node-1] => (item=apt-transport-https)
changed: [node-2] => (item=apt-transport-https)
ok: [node-1] => (item=ca-certificates)
ok: [node-2] => (item=ca-certificates)
changed: [master-1] => (item=gnupg-agent)
ok: [node-1] => (item=curl)
ok: [node-2] => (item=curl)
ok: [master-1] => (item=software-properties-common)
changed: [node-1] => (item=gnupg-agent)
changed: [node-2] => (item=gnupg-agent)
ok: [node-1] => (item=software-properties-common)
ok: [node-2] => (item=software-properties-common)
changed: [master-1] => (item=pip)
changed: [node-1] => (item=pip)
changed: [node-2] => (item=pip)

PLAY [Docker install] **********************************************************

TASK [docker : Add an apt signing keys for Docker] *****************************
changed: [node-2]
changed: [master-1]
changed: [node-1]

TASK [docker : Add an apt repository for Docker] *******************************
changed: [master-1]
changed: [node-2]
changed: [node-1]

TASK [docker : Install docker and its dependecies] *****************************
changed: [node-1] => (item=docker-ce)
changed: [node-2] => (item=docker-ce)
ok: [node-1] => (item=docker-ce-cli)
ok: [node-2] => (item=docker-ce-cli)
changed: [master-1] => (item=docker-ce)
ok: [node-2] => (item=containerd.io)
ok: [node-1] => (item=containerd.io)
ok: [master-1] => (item=docker-ce-cli)
ok: [master-1] => (item=containerd.io)
changed: [node-1] => (item=docker-compose)
changed: [node-2] => (item=docker-compose)
changed: [master-1] => (item=docker-compose)

TASK [docker : Install Docker Python library] **********************************
changed: [node-2]
changed: [master-1]
changed: [node-1]

TASK [docker : Configure the Docker daemon in particular to use systemd for the management of the containers cgroups.] ***
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker : Enable & Restart docker serivce] ********************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker : Add vagrant user to docker group] *******************************
changed: [master-1]
changed: [node-2]
changed: [node-1]

TASK [docker : Download RunC] **************************************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker : Copy RunC to /usr/local/sbin/] **********************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker : Create a directory for containerd default config] ***************
ok: [master-1]
ok: [node-2]
ok: [node-1]

TASK [docker : Generatate Containerd default config and push it to the config.toml file] ***
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker : SystemdCgroup = true] *******************************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker : Restart containerd, also do daemon-reload] **********************
changed: [master-1]
changed: [node-1]
changed: [node-2]

PLAY [Kubernetes & Helm install] ***********************************************

TASK [k8s : Disable SWAP since kubernetes can't work with swap enabled (1/2)] ***
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [k8s : Disable SWAP in fstab since kubernetes can't work with swap enabled (2/2)] ***
changed: [master-1]
changed: [node-2]
changed: [node-1]

TASK [k8s : Remove /swap.img] **************************************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [k8s : Add the br_netfilter and overlay modules] **************************
ok: [master-1] => (item=br_netfilter)
ok: [node-2] => (item=br_netfilter)
ok: [node-1] => (item=br_netfilter)
ok: [master-1] => (item=overlay)
ok: [node-2] => (item=overlay)
ok: [node-1] => (item=overlay)

TASK [k8s : Enable kernel modules] *********************************************
changed: [master-1] => (item=br_netfilter)
changed: [node-1] => (item=br_netfilter)
changed: [node-2] => (item=br_netfilter)
changed: [master-1] => (item=overlay)
changed: [node-1] => (item=overlay)
changed: [node-2] => (item=overlay)

TASK [k8s : Change systcl settings] ********************************************
changed: [master-1] => (item=net.bridge.bridge-nf-call-ip6tables)
changed: [node-2] => (item=net.bridge.bridge-nf-call-ip6tables)
changed: [node-1] => (item=net.bridge.bridge-nf-call-ip6tables)
changed: [master-1] => (item=net.bridge.bridge-nf-call-iptables)
changed: [node-2] => (item=net.bridge.bridge-nf-call-iptables)
changed: [node-1] => (item=net.bridge.bridge-nf-call-iptables)
changed: [master-1] => (item=net.ipv4.ip_forward)
changed: [node-2] => (item=net.ipv4.ip_forward)
changed: [node-1] => (item=net.ipv4.ip_forward)

TASK [k8s : Install python libraries] ******************************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [k8s : Add an apt signing key for Kubernetes] *****************************
changed: [node-1]
changed: [node-2]
changed: [master-1]

TASK [k8s : Add apt repository for Kubernetes] *********************************
changed: [master-1]
changed: [node-2]
changed: [node-1]

TASK [k8s : Install Kubernetes binaries] ***************************************
changed: [node-2] => (item=kubelet=1.24.4-00)
changed: [master-1] => (item=kubelet=1.24.4-00)
changed: [node-1] => (item=kubelet=1.24.4-00)
changed: [node-2] => (item=kubeadm=1.24.4-00)
changed: [master-1] => (item=kubeadm=1.24.4-00)
changed: [node-1] => (item=kubeadm=1.24.4-00)
changed: [node-2] => (item=kubectl=1.24.4-00)
changed: [master-1] => (item=kubectl=1.24.4-00)
changed: [node-1] => (item=kubectl=1.24.4-00)

TASK [k8s : Add an apt signing key for Helm] ***********************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [k8s : Add apt repository for Helm] ***************************************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [k8s : Install Helm] ******************************************************
changed: [master-1]
changed: [node-2]
changed: [node-1]

PLAY [Initialize cluster] ******************************************************

TASK [cluster-init : Check if kubeadm has already run] *************************
ok: [master-1]

TASK [cluster-init : Init cluster if needed] ***********************************
included: /vagrant/ansible/roles/cluster-init/tasks/init.yaml for master-1

TASK [cluster-init : Reset Kubernetes component if needed] *********************
changed: [master-1]

TASK [cluster-init : Pull required containers if needed] ***********************
changed: [master-1]

TASK [cluster-init : Init Kubernetes cluster if needed] ************************
changed: [master-1]

TASK [cluster-init : Setup kubeconfig for vagrant user 1/4] ********************
changed: [master-1]

TASK [cluster-init : Check if config already exists 2/4 pt.1] ******************
ok: [master-1]

TASK [cluster-init : Setup kubeconfig for vagrant user 2/4 pt.2] ***************
changed: [master-1]

TASK [cluster-init : Setup kubeconfig for vagrant user 3/4] ********************
changed: [master-1]

TASK [cluster-init : Setup kubeconfig for vagrant user 4/4 pt.1] ***************
changed: [master-1]

TASK [cluster-init : Setup kubeconfig for vagrant user 4/4 pt.2] ***************
changed: [master-1]

TASK [cluster-init : Generate join command] ************************************
changed: [master-1]

TASK [cluster-init : Set perms of join_command] ********************************
ok: [master-1]

TASK [cluster-init : Enable and check kubelet service] *************************
ok: [master-1]

TASK [cluster-init : Add helm repositories] ************************************
changed: [master-1]

TASK [cluster-init : Deploy Calico chart] **************************************
changed: [master-1]

PLAY [Join nodes to the cluster] ***********************************************

TASK [cluster-join : Copy the join command to server location] *****************
changed: [node-2]
changed: [node-1]

RUNNING HANDLER [cluster-join : Join_node] *************************************
changed: [node-1]
changed: [node-2]

PLAY [Docker-Registry install & Create SSL certificates] ***********************

TASK [docker-registry : Install Python libraries] ******************************
changed: [master-1]

TASK [docker-registry : Install htpasswd] **************************************
changed: [master-1]

TASK [docker-registry : Create auth and certs directories if they do not exist] ***
ok: [master-1] => (item=/vagrant/auth)
ok: [master-1] => (item=/vagrant/certs)

TASK [docker-registry : Generate an OpenSSL private key] ***********************
ok: [master-1]

TASK [docker-registry : Generate an OpenSSL Certificate Signing Request with Subject information] ***
ok: [master-1]

TASK [docker-registry : Generate a Self Signed OpenSSL certificate] ************
ok: [master-1]

TASK [docker-registry : Generate htpasswd file] ********************************
ok: [master-1]

TASK [docker-registry : Create k8s secret with docker.registry.com login credentials] ***
changed: [master-1]

TASK [docker-registry : Run docker-compose up and start docker-registry service] ***
changed: [master-1]

PLAY [Docker-Registry certs config] ********************************************

TASK [docker-registry-config : Add 'insecure-registries' entry to daemon.json config file] ***
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker-registry-config : Add 'insecure registry' entry to containerd config file] ***
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker-registry-config : Pasting docker.registry.com entry to /etc/hosts] ***
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker-registry-config : Create directories for copying certificates] ****
changed: [master-1] => (item=/etc/docker/certs.d/docker.registry.com:5000/)
changed: [node-1] => (item=/etc/docker/certs.d/docker.registry.com:5000/)
changed: [node-2] => (item=/etc/docker/certs.d/docker.registry.com:5000/)
changed: [master-1] => (item=/etc/containerd/certs.d/docker.registry.com:5000/)
changed: [node-2] => (item=/etc/containerd/certs.d/docker.registry.com:5000/)
changed: [node-1] => (item=/etc/containerd/certs.d/docker.registry.com:5000/)

TASK [docker-registry-config : Copy certificates to docker certs.d] ************
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker-registry-config : Copy certificates to containerd certs.d] ********
changed: [master-1]
changed: [node-1]
changed: [node-2]

TASK [docker-registry-config : Restart docker and containerd, also do daemon-reload] ***
changed: [node-1] => (item=docker)
changed: [master-1] => (item=docker)
changed: [node-2] => (item=docker)
changed: [master-1] => (item=containerd)
changed: [node-1] => (item=containerd)
changed: [node-2] => (item=containerd)

PLAY [Install MetalLB load balancer on master node] ****************************

TASK [metallb : Modify kube-proxy config file to enable strict ARP so we can use MetalLB properly] ***
changed: [master-1]

TASK [metallb : Add MetalLB helm chart repo] ***********************************
changed: [master-1]

TASK [metallb : Deploy MetalLB chart] ******************************************
changed: [master-1]

TASK [metallb : Wait till all pods with namespace metallb-system are ready.] ***
changed: [master-1]

TASK [metallb : Delete ValidatingWebhookConfiguration for metallb] *************
changed: [master-1]

TASK [metallb : Create IPAddressPool deployment] *******************************
changed: [master-1]

TASK [metallb : Create L2Advertisement deployment] *****************************
changed: [master-1]

PLAY [Install ingress-nginx controller on master node] *************************

TASK [ingress-nginx : Add helm chart repository for ingress-nginx controller] ***
changed: [master-1]

TASK [ingress-nginx : Deploy ingress-nginx chart] ******************************
changed: [master-1]

PLAY [Run bash script that will upload image to docker registry] ***************

TASK [Running bash script] *****************************************************
changed: [master-1]

PLAY RECAP *********************************************************************
master-1                   : ok=79   changed=65   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
node-1                     : ok=46   changed=41   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
node-2                     : ok=46   changed=41   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   




